<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Minto | WoW Classic SoD</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Wowhead Power.js for tooltips -->
  <script src="https://wow.zamimg.com/widgets/power.js"></script>
  <style>
    body {
      background-color: #1a1a1a; /* Dark background */
      color: #e0e0e0; /* Light text */
    }
    .recipe-card {
      margin-bottom: 1rem;
    }
    .profit-positive {
      color: #28a745; /* Green for positive profit */
      font-weight: bold;
    }
    .profit-negative {
      color: #dc3545; /* Red for negative profit */
      font-weight: bold;
    }
    .filter-container {
      margin-bottom: 2rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .item-link {
      text-decoration: none;
      color: #66b0ff; /* Lighter blue for links */
    }
    .item-link:hover {
      text-decoration: underline;
      color: #99ccff; /* Lighter hover color */
    }
    /* Card styling for dark mode */
    .card {
      background-color: #2c2c2c; /* Dark card background */
      border: 1px solid #444; /* Subtle border */
      color: #e0e0e0; /* Light text */
    }
    /* Dropdown styling for dark mode */
    .form-select {
      background-color: #333; /* Dark dropdown background */
      color: #e0e0e0; /* Light text */
      border: 1px solid #555; /* Subtle border */
    }
    .form-select:focus {
      background-color: #333;
      color: #e0e0e0;
      border-color: #66b0ff; /* Highlight border on focus */
      box-shadow: 0 0 0 0.25rem rgba(102, 176, 255, 0.25); /* Bootstrap-style focus shadow */
    }
    .form-select option {
      background-color: #333; /* Dark option background */
      color: #e0e0e0; /* Light option text */
    }
    /* Label styling */
    .form-label {
      color: #e0e0e0; /* Light label text */
    }
    /* Error message styling */
    .text-danger {
      color: #ff6666 !important; /* Lighter red for error messages */
    }
    /* Ensure Wowhead tooltips are visible in dark mode */
    .wowhead-tooltip {
      z-index: 1000; /* Ensure tooltips appear above other elements */
    }
  </style>
</head>
<body>
  <main class="container my-4">
    <h1 class="text-center mb-4">WoW Classic SoD Crafting Prices</h1>

    <section class="filter-container">
      <div>
        <label for="professionFilter" class="form-label">Filter by Profession:</label>
        <select id="professionFilter" class="form-select w-100 w-md-25">
          <option value="all">All Professions</option>
        </select>
      </div>
      <div>
        <label for="sortFilter" class="form-label">Sort by:</label>
        <select id="sortFilter" class="form-select w-100 w-md-25">
          <option value="default">Default</option>
          <option value="profit-desc" selected>Profit (High to Low)</option>
          <option value="profit-asc">Profit (Low to High)</option>
        </select>
      </div>
    </section>

    <section id="recipeList" class="row" aria-live="polite"></section>
  </main>

  <script>
    let materials = [];
    let recipes = [];
    let pricing = [];

    const professionFilter = document.getElementById("professionFilter");
    const sortFilter = document.getElementById("sortFilter");
    const recipeList = document.getElementById("recipeList");

    const formatCopper = (copper) => {
      if (!copper) return "N/A";
      const gold = Math.floor(copper / 10000);
      const silver = Math.floor((copper % 10000) / 100);
      const cop = copper % 100;
      return `${gold ? gold + 'g ' : ''}${silver ? silver + 's ' : ''}${cop}c`.trim();
    };

    const calculateRecipeCost = (recipe, priceMap) => {
      let totalCost = 0;
      recipe.materials.forEach(mat => {
        const price = priceMap.get(mat.itemId) || 0;
        totalCost += price * mat.quantity;
      });
      const resultPrice = priceMap.get(recipe.result.itemId) || 0;
      const profit = (resultPrice * recipe.result.quantity) - totalCost;
      return { totalCost, profit, resultPrice };
    };

    const renderRecipes = (filterProfession = "all", sortOption = "default") => {
      recipeList.innerHTML = "";
      const priceMap = new Map(pricing.map(p => [p.itemId, p.marketValue]));
      const materialMap = new Map(materials.map(m => [m.itemId, m.name]));

      // Filter recipes by profession
      let filteredRecipes = filterProfession === "all"
        ? recipes
        : recipes.filter(r => r.profession === filterProfession);

      // Sort recipes based on sortOption
      if (sortOption === "profit-desc") {
        filteredRecipes = filteredRecipes.sort((a, b) => {
          const profitA = calculateRecipeCost(a, priceMap).profit;
          const profitB = calculateRecipeCost(b, priceMap).profit;
          return profitB - profitA; // High to low
        });
      } else if (sortOption === "profit-asc") {
        filteredRecipes = filteredRecipes.sort((a, b) => {
          const profitA = calculateRecipeCost(a, priceMap).profit;
          const profitB = calculateRecipeCost(b, priceMap).profit;
          return profitA - profitB; // Low to high
        });
      }

      filteredRecipes.forEach(recipe => {
        const { totalCost, profit, resultPrice } = calculateRecipeCost(recipe, priceMap);
        const resultName = materialMap.get(recipe.result.itemId) || "Unknown Item";

        const materialsHTML = recipe.materials.map(mat => {
          const name = materialMap.get(mat.itemId) || "Unknown";
          const matPrice = (priceMap.get(mat.itemId) || 0) * mat.quantity;
          return `
            <li>
              <a href="https://www.wowhead.com/classic/item=${mat.itemId}" 
                 class="item-link" 
                 data-wowhead="item=${mat.itemId}" 
                 target="_blank" 
                 rel="noopener noreferrer">
                ${name}
              </a> x${mat.quantity} (${formatCopper(matPrice)})
            </li>`;
        }).join("");

        recipeList.insertAdjacentHTML("beforeend", `
          <div class="col-md-4 recipe-card">
            <div class="card h-100">
              <div class="card-body">
                <h5 class="card-title">${recipe.name}</h5>
                <img src="https://wow.zamimg.com/images/wow/icons/large/${recipe.icon}.jpg">
                <p class="card-text">
                  <strong>Profession:</strong> ${recipe.profession}<br>
                  <strong>Skill Level:</strong> ${recipe.skillLevel}<br>
                  <strong>Result:</strong>
                  <a href="https://www.wowhead.com/classic/item=${recipe.result.itemId}" 
                     class="item-link" 
                     data-wowhead="item=${recipe.result.itemId}" 
                     target="_blank" 
                     rel="noopener noreferrer">
                    ${resultName}
                  </a> x${recipe.result.quantity} (${formatCopper(resultPrice)})<br>
                  <strong>Materials:</strong>
                  <ul>${materialsHTML}</ul>
                  <strong>Total Cost:</strong> ${formatCopper(totalCost)}<br>
                  <strong>Profit:</strong> 
                  <span class="${profit >= 0 ? 'profit-positive' : 'profit-negative'}">
                    ${formatCopper(profit)}
                  </span>
                </p>
              </div>
            </div>
          </div>
        `);
      });
    };

    const loadData = async () => {
      try {
        const [matRes, recRes, priceRes] = await Promise.all([
          fetch('materials.json'),
          fetch('recipes.json'),
          fetch('horde.json')
        ]);
        materials = await matRes.json();
        recipes = await recRes.json();
        const priceData = await priceRes.json();
        pricing = priceData.pricing_data;

        // Fill profession filter and set Alchemy as default
        const professions = [...new Set(recipes.map(r => r.profession))];
        professions.forEach(prof => {
          const option = document.createElement("option");
          option.value = prof;
          option.textContent = prof;
          if (prof === "Alchemy") {
            option.selected = true; // Set Alchemy as default
          }
          professionFilter.appendChild(option);
        });

        renderRecipes("Alchemy", "profit-desc"); // Default to Alchemy and profit high to low
      } catch (err) {
        console.error("Failed to load data:", err);
        recipeList.innerHTML = `<p class="text-danger">Error loading data. Check console for details.</p>`;
      }
    };

    professionFilter.addEventListener("change", (e) => {
      renderRecipes(e.target.value, sortFilter.value);
    });

    sortFilter.addEventListener("change", (e) => {
      renderRecipes(professionFilter.value, e.target.value);
    });

    document.addEventListener("DOMContentLoaded", loadData);
  </script>
</body>
</html>
